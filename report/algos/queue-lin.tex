%!TEX root=../main.tex

\begin{algorithm}
\caption{Linearizability Monitoring for Queue Histories with Distinct Values}
\algolabel{queue-algo}
\myproc{\QueueLin{$H$}}{
\lIf{$H = \varnothing$}
{
    \Return true
}
\;
$PushEvents \gets \bigcup_{o\in H \land \methodOf{o} = \push}\set{\tuple{\resTimeOf{o}, 0, \valOf{o}}, \tuple{\invTimeOf{o}, 1, \valOf{o}}}$\;
\tcp{Let $MinPeekPopRes$ be a hashtable and $MaxInv$ be an empty list}
\For{$v\in H$}
{
    $MinPeekPopRes[v] \gets \tuple{\min\set{\resTimeOf{o} \;|\; o\in H_v \land \methodOf{o}\in\set{\peek, \pop}}, 0, v}$\;
    $MaxInv$.insert($\tuple{\max\set{\invTimeOf{o} \;|\; o\in H_v}, 1, v}$)\;
}
$PeekPopEvents \gets MaxInv \cup MinPeekPopRes.vals()$\;
Sort $PushEvents$, $MaxInv$ and $PeekPopEvents$ in descending order\;
\;
$MaxPush \gets \varnothing$\;
\For{$\tuple{t, e, v} \in PushEvents$}
{
    $MaxPush$.insert($v$)\;
    \tcp{Break on last invocation}
    \lIf{e = 1}{\Break}
}
\;
$\MPV_H \gets \varnothing$\;
\For{$\tuple{t, e, v} \in PeekPopEvents$}
{
    \If{$v \in MaxPush$}
    {
        $\MPV_H$.insert($v$)\;
    }
    
    \tcp{Break on last maximum invocation}
    \If{e = 1}{
        \If{$MinPeekPopRes[v][0] > MaxInv[1]$ \AND $v \in MaxPush$}
        {
            $\MPV_H$.insert($v$)\;
        }
        \Break
    }
}
\;
\lIf{$\MPV_H = \varnothing$}
{
    \Return false
}
\Return \QueueLin{$H \setminus \set{o\in H \;|\; \valOf{o}\in \MPV_H}$}
}
\end{algorithm}